<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Endless Worldle</title>

<style>
:root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
* { box-sizing: border-box; }
body { margin:0; background:#0b0d12; color:#e9eefc; }

/* Header */
header{
  padding: 12px 12px 10px 12px;
  background:#0f1220;
  border-bottom:1px solid rgba(255,255,255,.10);
  position: sticky;
  top: 0;
  z-index: 20;
}
h1{ margin:0; font-size:18px; line-height: 1.2; }

/* Main layout */
main{
  padding: 12px;
  padding-bottom: calc(210px + env(safe-area-inset-bottom));
}
@media (min-width: 840px){
  main{ display:grid; grid-template-columns: 1.3fr .7fr; gap: 12px; }
}

.panel{
  background: rgba(255,255,255,.04);
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  overflow:hidden;
}
.panel h3{
  margin:0;
  padding: 10px 12px;
  font-size: 13px;
  border-bottom: 1px solid rgba(255,255,255,.10);
}
#silWrap { height: 60vh; min-height: 360px; }
@media (min-width: 840px){
  #silWrap { height: calc(100vh - 320px); min-height: 460px; }
}
.footer{
  padding: 10px 12px;
  font-size: 12px;
  opacity: .8;
  border-top: 1px solid rgba(255,255,255,.10);
  display:flex;
  gap: 12px;
  flex-wrap: wrap;
}

ol{ margin:0; padding: 10px 18px 16px 34px; font-size: 13px; }
ol li{ margin: 8px 0; }

.badge{
  display:inline-block;
  font-size: 11px;
  opacity:.95;
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.15);
  margin-left: 8px;
}
.badge.good { border-color: rgba(80,255,160,.5); }
.badge.bad  { border-color: rgba(255,210,90,.5); }
.badge.err  { border-color: rgba(255,80,80,.45); }
.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

button{
  height: 44px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.15);
  background: rgba(255,255,255,.06);
  color:#fff;
  padding: 0 14px;
  cursor:pointer;
}
button:hover { background: rgba(255,255,255,.10); }
button.danger{ border-color: rgba(255,80,80,.45); }

input{
  height: 44px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.15);
  background: rgba(255,255,255,.06);
  color:#fff;
  padding: 0 12px;
  width: 100%;
}
label{ display:grid; gap:6px; font-size:12px; opacity:.92; }

/* Bottom bars */
.bottomStack{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 120;
  padding-bottom: env(safe-area-inset-bottom);
}
.bottomBar, .giveUpBar{
  background: rgba(15,18,32,.96);
  border-top: 1px solid rgba(255,255,255,.12);
  backdrop-filter: blur(10px);
}
.giveUpBar{ padding: 10px 12px; }
.bottomBar{ padding: 10px 12px 12px 12px; }

.compactRow{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.smallMeta{
  font-size: 12px;
  opacity: .85;
  display:flex;
  gap: 14px;
  flex-wrap: wrap;
  margin-top: 8px;
}
.barRow{
  display:grid;
  grid-template-columns: 1fr;
  gap: 10px;
}
@media (min-width: 840px){
  .barRow{ grid-template-columns: 240px 1fr; align-items:end; }
}

/* ===== Modal system ===== */
.backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  z-index: 999;
}
.modal{
  position: fixed;
  left: 12px;
  right: 12px;
  top: 80px; /* adjusted by JS */
  max-height: min(70vh, 520px);
  background: rgba(15,18,32,.98);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 16px;
  box-shadow: 0 22px 55px rgba(0,0,0,.55);
  overflow: hidden;
  display: none;
  z-index: 1000;
}
@media (min-width: 840px){
  .modal{
    left: 50%;
    transform: translateX(-50%);
    max-width: 680px;
  }
}

.modalHeader{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding: 10px;
  border-bottom: 1px solid rgba(255,255,255,.10);
}
.modalHeader strong{ font-size: 14px; }
.modalClose{
  width: 44px;
  padding: 0;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius: 12px;
}

/* Search bar inside country modal */
.searchWrap{
  position: sticky;
  top: 0;
  background: rgba(15,18,32,.98);
  padding: 10px;
  border-bottom: 1px solid rgba(255,255,255,.10);
  z-index: 2;
}

/* Scrollable list */
.modalList{
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  height: 40vh; /* fallback */
}
@media (min-width: 840px){
  .modalList{ height: 360px; }
}

/* Items */
.item{
  padding: 12px 14px;
  cursor: pointer;
  border-top: 1px solid rgba(255,255,255,.06);
  font-size: 15px;
}
.item:hover{ background: rgba(255,255,255,.08); }
.item.selected{
  background: rgba(255,255,255,.12);
  outline: 1px solid rgba(255,255,255,.18);
}

/* Confirm bar */
.confirmBar{
  position: sticky;
  bottom: 0;
  display: none;
  gap: 10px;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  border-top: 1px solid rgba(255,255,255,.10);
  background: rgba(15,18,32,.98);
  z-index: 3;
}
.confirmText{
  font-size: 12px;
  opacity: .9;
  line-height: 1.2;
}
.confirmText strong{ font-size: 13px; opacity: 1; }
</style>
</head>

<body>

<header id="topHeader">
  <h1>Endless Worldle</h1>
</header>

<main>
  <div class="panel">
    <h3>Silhouette</h3>
    <div id="silWrap"></div>
    <div class="footer">
      <div>Drag to pan • Pinch/scroll to zoom • Double-click/tap to zoom</div>
      <div>Wrong-guess format: <span class="mono">↗ NE • 1,245 km</span></div>
    </div>
  </div>

  <div class="panel" style="margin-top:12px;">
    <h3>Guesses</h3>
    <ol id="guesses"></ol>
  </div>
</main>

<!-- Country picker modal (keeps SEARCH BAR; selection behavior matches MODE) -->
<div id="countryBackdrop" class="backdrop"></div>
<div id="countryModal" class="modal" role="dialog" aria-label="Country picker">
  <div class="modalHeader">
    <strong>Select a country</strong>
    <button id="countryClose" class="modalClose" aria-label="Close">✕</button>
  </div>

  <div class="searchWrap">
    <input id="countrySearch" placeholder="Search countries…" autocomplete="off" inputmode="search" />
  </div>

  <div id="countryList" class="modalList"></div>

  <div id="countryConfirmBar" class="confirmBar">
    <div class="confirmText">
      Selected: <strong id="countryConfirmName">—</strong><br/>
      Tap the same country again to confirm, or press Confirm.
    </div>
    <button id="countryConfirmBtn">Confirm</button>
  </div>
</div>

<!-- Mode picker modal -->
<div id="modeBackdrop" class="backdrop"></div>
<div id="modeModal" class="modal" role="dialog" aria-label="Mode picker">
  <div class="modalHeader">
    <strong>Select a mode</strong>
    <button id="modeClose" class="modalClose" aria-label="Close">✕</button>
  </div>

  <div id="modeList" class="modalList"></div>

  <div id="modeConfirmBar" class="confirmBar">
    <div class="confirmText">
      Selected: <strong id="modeConfirmName">—</strong><br/>
      Tap the same mode again to confirm, or press Confirm.
    </div>
    <button id="modeConfirmBtn">Confirm</button>
  </div>
</div>

<div class="bottomStack">
  <div class="giveUpBar">
    <div class="compactRow">
      <button id="guessBtn">Guess</button>
      <button id="new">New</button>
      <button id="giveUp" class="danger">Give Up</button>
    </div>

    <div class="smallMeta">
      <div>Attempts: <span id="attempts">0</span></div>
      <div>Hint: <span id="hint">—</span></div>
      <div>Answer: <span id="answer">—</span></div>
    </div>
  </div>

  <div class="bottomBar">
    <div class="barRow">
      <label>
        Mode (tap to open)
        <button id="modeBtn" type="button">All Countries</button>
      </label>

      <label>
        Guess (type OR tap to open list)
        <input id="guess" placeholder="Type a country name…" autocomplete="off" inputmode="search" />
      </label>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

<script>
/* ===== Regions (modes) ===== */
const regions = {
  "All Countries": [],

  "North America": ["Canada","United States of America","Mexico"],
  "Central America": ["Belize","Costa Rica","El Salvador","Guatemala","Honduras","Nicaragua","Panama"],
  "Caribbean": ["Antigua and Barbuda","Bahamas","Barbados","Cuba","Dominica","Dominican Republic","Grenada","Haiti","Jamaica","Saint Kitts and Nevis","Saint Lucia","Saint Vincent and the Grenadines","Trinidad and Tobago"],
  "South America": ["Argentina","Bolivia","Brazil","Chile","Colombia","Ecuador","Guyana","Paraguay","Peru","Suriname","Uruguay","Venezuela"],

  "Europe": ["Albania","Andorra","Austria","Belarus","Belgium","Bosnia and Herzegovina","Bulgaria","Croatia","Cyprus","Czechia","Denmark","Estonia","Finland","France","Germany","Greece","Hungary","Iceland","Ireland","Italy","Kosovo","Latvia","Liechtenstein","Lithuania","Luxembourg","Malta","Moldova","Monaco","Montenegro","Netherlands","North Macedonia","Norway","Poland","Portugal","Romania","Russia","San Marino","Serbia","Slovakia","Slovenia","Spain","Sweden","Switzerland","Ukraine","United Kingdom","Vatican"],

  "Northern Africa": ["Algeria","Egypt","Libya","Morocco","Sudan","Tunisia","Western Sahara"],
  "Western Africa": ["Benin","Burkina Faso","Cabo Verde","Cape Verde","Gambia","Ghana","Guinea","Guinea-Bissau","Liberia","Mali","Mauritania","Niger","Nigeria","Senegal","Sierra Leone","Togo","Cote d'Ivoire","Côte d'Ivoire"],
  "Central Africa": ["Angola","Cameroon","Central African Republic","Chad","Congo","Democratic Republic of the Congo","Equatorial Guinea","Gabon","Sao Tome and Principe","São Tomé and Príncipe"],
  "Eastern Africa": ["Burundi","Comoros","Djibouti","Eritrea","Ethiopia","Kenya","Madagascar","Malawi","Mauritius","Mozambique","Rwanda","Seychelles","Somalia","South Sudan","Sudan","Tanzania","Uganda","Zambia","Zimbabwe"],
  "Southern Africa": ["Botswana","Eswatini","Lesotho","Namibia","South Africa"],

  "Middle East": ["Bahrain","Iran","Iraq","Israel","Jordan","Kuwait","Lebanon","Oman","Qatar","Saudi Arabia","Syria","Turkey","United Arab Emirates","Yemen","Palestine"],
  "South Asia": ["Afghanistan","Bangladesh","Bhutan","India","Maldives","Nepal","Pakistan","Sri Lanka"],
  "East Asia": ["China","Japan","Mongolia","North Korea","South Korea","Taiwan"],
  "South East Asia": ["Brunei","Cambodia","Indonesia","Laos","Malaysia","Myanmar","Philippines","Singapore","Thailand","Timor-Leste","Vietnam"],
  "Central Asia": ["Kazakhstan","Kyrgyzstan","Tajikistan","Turkmenistan","Uzbekistan"],
  "Caucasus": ["Armenia","Azerbaijan","Georgia"],

  "Oceania": ["Australia","New Zealand","Papua New Guinea","Fiji","Solomon Islands","Vanuatu","Samoa","Tonga","Kiribati","Tuvalu","Nauru","Micronesia","Marshall Islands","Palau"],
  "Pacific Islands": ["Fiji","Solomon Islands","Vanuatu","Samoa","Tonga","Kiribati","Tuvalu","Nauru","Micronesia","Marshall Islands","Palau"]
};

const els = {
  header: document.getElementById("topHeader"),

  wrap: document.getElementById("silWrap"),
  guesses: document.getElementById("guesses"),
  attempts: document.getElementById("attempts"),
  hint: document.getElementById("hint"),
  answer: document.getElementById("answer"),

  guess: document.getElementById("guess"),
  guessBtn: document.getElementById("guessBtn"),
  newBtn: document.getElementById("new"),
  giveUpBtn: document.getElementById("giveUp"),

  modeBtn: document.getElementById("modeBtn"),

  // country modal
  countryBackdrop: document.getElementById("countryBackdrop"),
  countryModal: document.getElementById("countryModal"),
  countryClose: document.getElementById("countryClose"),
  countrySearch: document.getElementById("countrySearch"),
  countryList: document.getElementById("countryList"),
  countryConfirmBar: document.getElementById("countryConfirmBar"),
  countryConfirmName: document.getElementById("countryConfirmName"),
  countryConfirmBtn: document.getElementById("countryConfirmBtn"),

  // mode modal
  modeBackdrop: document.getElementById("modeBackdrop"),
  modeModal: document.getElementById("modeModal"),
  modeClose: document.getElementById("modeClose"),
  modeList: document.getElementById("modeList"),
  modeConfirmBar: document.getElementById("modeConfirmBar"),
  modeConfirmName: document.getElementById("modeConfirmName"),
  modeConfirmBtn: document.getElementById("modeConfirmBtn"),
};

const norm = (s) => (s || "").trim().toLowerCase();
const getName = (f) => f?.properties?.name || "";

/* Data */
let allFeatures = [];
let allNames = [];
let byName = new Map();
let activePool = [];
let answerFeature = null;
let attempts = 0;
let currentMode = "All Countries";

/* Two-tap selection state */
let selectedCountryName = "";
let lastTappedCountry = "";
let selectedModeName = "";
let lastTappedMode = "";

/* D3 */
let svg, g, path, zoom;

/* UI helpers */
function setHint(msg){ els.hint.textContent = msg || "—"; }
function setAnswer(msg){ els.answer.textContent = msg || "—"; }
function addGuessLine(text, badgeText="", badgeClass=""){
  const li = document.createElement("li");
  li.textContent = text;
  if (badgeText){
    const span = document.createElement("span");
    span.className = "badge " + (badgeClass || "");
    span.textContent = badgeText;
    li.appendChild(span);
  }
  els.guesses.prepend(li);
}
function resetRoundUI(){
  attempts = 0;
  els.attempts.textContent = "0";
  els.guesses.innerHTML = "";
  setHint("—");
  setAnswer("—");
}
function resetCountryPicker(){
  els.countrySearch.value = "";
  els.guess.value = "";
  clearCountrySelection();
  renderCountryList("");
  // scroll list to top for convenience
  els.countryList.scrollTop = 0;
}

/* Modal helpers */
function modalTop(){
  const r = els.header.getBoundingClientRect();
  return Math.max(10, Math.ceil(r.bottom + 8));
}
function openModal(backdropEl, modalEl){
  modalEl.style.top = `calc(${modalTop()}px + env(safe-area-inset-top))`;
  backdropEl.style.display = "block";
  modalEl.style.display = "block";
}
function closeModal(backdropEl, modalEl){
  backdropEl.style.display = "none";
  modalEl.style.display = "none";
}

/* Active pool */
function setActivePool(){
  const list = regions[currentMode] || [];
  if (!list.length){ activePool = allFeatures.slice(); return; }
  const wanted = new Set(list.map(norm));
  activePool = allFeatures.filter(f => wanted.has(norm(getName(f))));
  if (!activePool.length) activePool = allFeatures.slice();
}

/* Scroll sizing */
function sizeCountryList(){
  const modalH = els.countryModal.clientHeight || 0;
  const headerH = els.countryModal.querySelector(".modalHeader")?.clientHeight || 0;
  const searchH = els.countryModal.querySelector(".searchWrap")?.clientHeight || 0;
  const confirmH = els.countryConfirmBar.style.display === "none" ? 0 : (els.countryConfirmBar.clientHeight || 0);
  els.countryList.style.height = Math.max(180, modalH - headerH - searchH - confirmH) + "px";
}
function sizeModeList(){
  const modalH = els.modeModal.clientHeight || 0;
  const headerH = els.modeModal.querySelector(".modalHeader")?.clientHeight || 0;
  const confirmH = els.modeConfirmBar.style.display === "none" ? 0 : (els.modeConfirmBar.clientHeight || 0);
  els.modeList.style.height = Math.max(180, modalH - headerH - confirmH) + "px";
}

/* COUNTRY selection/confirm (same behavior as mode) */
function showCountryConfirm(name){
  selectedCountryName = name;
  els.countryConfirmName.textContent = name || "—";
  els.countryConfirmBar.style.display = name ? "flex" : "none";
  sizeCountryList();
}
function clearCountrySelection(){
  selectedCountryName = "";
  lastTappedCountry = "";
  els.countryConfirmBar.style.display = "none";
  els.countryConfirmName.textContent = "—";
  [...els.countryList.querySelectorAll(".item.selected")].forEach(el => el.classList.remove("selected"));
  sizeCountryList();
}
function confirmCountry(){
  if (!selectedCountryName) return;
  els.guess.value = selectedCountryName;
  closeModal(els.countryBackdrop, els.countryModal);
  els.guess.focus({preventScroll:true});
}

/* MODE selection/confirm */
function showModeConfirm(name){
  selectedModeName = name;
  els.modeConfirmName.textContent = name || "—";
  els.modeConfirmBar.style.display = name ? "flex" : "none";
  sizeModeList();
}
function clearModeSelection(){
  selectedModeName = "";
  lastTappedMode = "";
  els.modeConfirmBar.style.display = "none";
  els.modeConfirmName.textContent = "—";
  [...els.modeList.querySelectorAll(".item.selected")].forEach(el => el.classList.remove("selected"));
  sizeModeList();
}
function confirmMode(){
  if (!selectedModeName) return;
  currentMode = selectedModeName;
  els.modeBtn.textContent = currentMode;
  closeModal(els.modeBackdrop, els.modeModal);
  clearModeSelection();
  // reset search/guess when changing mode
  resetCountryPicker();
  newRound();
}

/* Country list render (search + two-tap confirm) */
function renderCountryList(filterText){
  const q = norm(filterText);
  els.countryList.innerHTML = "";

  const matches = q ? allNames.filter(n => norm(n).includes(q)) : allNames;
  const cap = 500;
  const shown = matches.slice(0, cap);

  for (const name of shown){
    const div = document.createElement("div");
    div.className = "item";
    div.textContent = name;

    div.addEventListener("pointerdown", (e) => {
      e.preventDefault();

      if (lastTappedCountry && lastTappedCountry === name){
        selectedCountryName = name;
        confirmCountry();
        return;
      }

      lastTappedCountry = name;
      selectedCountryName = name;

      [...els.countryList.querySelectorAll(".item.selected")].forEach(el => el.classList.remove("selected"));
      div.classList.add("selected");
      showCountryConfirm(name);
    });

    els.countryList.appendChild(div);
  }

  if (!shown.length){
    const empty = document.createElement("div");
    empty.className = "item";
    empty.style.opacity = "0.7";
    empty.textContent = "No matches. Try a different spelling.";
    els.countryList.appendChild(empty);
  }

  clearCountrySelection();
  sizeCountryList();
}

/* Mode list render (two-tap confirm) */
function renderModeList(){
  els.modeList.innerHTML = "";
  const modeNames = Object.keys(regions);

  for (const modeName of modeNames){
    const div = document.createElement("div");
    div.className = "item";
    div.textContent = modeName;

    div.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      if (lastTappedMode && lastTappedMode === modeName){
        selectedModeName = modeName;
        confirmMode();
        return;
      }
      lastTappedMode = modeName;
      selectedModeName = modeName;

      [...els.modeList.querySelectorAll(".item.selected")].forEach(el => el.classList.remove("selected"));
      div.classList.add("selected");
      showModeConfirm(modeName);
    });

    els.modeList.appendChild(div);
  }

  clearModeSelection();
  sizeModeList();
}

/* D3 init */
function initSvg(){
  const rect = els.wrap.getBoundingClientRect();
  const w = Math.max(2, Math.floor(rect.width));
  const h = Math.max(2, Math.floor(rect.height));

  svg = d3.select("#silWrap").append("svg")
    .attr("width","100%")
    .attr("height","100%")
    .attr("viewBox", `0 0 ${w} ${h}`);

  g = svg.append("g");

  zoom = d3.zoom().scaleExtent([0.35, 18]).on("zoom", (event) => g.attr("transform", event.transform));
  svg.call(zoom);

  svg.on("dblclick.zoom", null);
  svg.on("dblclick", (event) => {
    event.preventDefault();
    svg.transition().duration(220).call(zoom.scaleBy, 1.35);
  });
}

/* Render silhouette */
function clearDrawing(){ g.selectAll("*").remove(); }
function renderSilhouette(feature){
  clearDrawing();

  const rect = els.wrap.getBoundingClientRect();
  const w = Math.max(2, Math.floor(rect.width));
  const h = Math.max(2, Math.floor(rect.height));

  const projection = d3.geoMercator();
  path = d3.geoPath(projection);
  projection.fitSize([w, h], feature);

  g.append("path")
    .datum(feature)
    .attr("d", path)
    .attr("fill", "rgba(255,255,255,0.06)")
    .attr("stroke", "rgba(255,255,255,0.86)")
    .attr("stroke-width", 0.95)
    .attr("vector-effect", "non-scaling-stroke");

  let [[x0, y0], [x1, y1]] = path.bounds(feature);
  const ok = [x0,y0,x1,y1].every(Number.isFinite);

  if (!ok){
    const [lon, lat] = d3.geoCentroid(feature);
    const pt = projection([lon, lat]) || [w/2, h/2];
    const cx = pt[0], cy = pt[1];
    g.append("circle").attr("cx", cx).attr("cy", cy).attr("r", 7)
      .attr("fill", "rgba(255,255,255,0.30)")
      .attr("stroke", "rgba(255,255,255,0.95)")
      .attr("stroke-width", 1)
      .attr("vector-effect", "non-scaling-stroke");
    const k = 10;
    svg.call(zoom.transform, d3.zoomIdentity.translate((w/2)-k*cx, (h/2)-k*cy).scale(k));
    return;
  }

  const dx = Math.max(0.0001, x1 - x0);
  const dy = Math.max(0.0001, y1 - y0);
  const largest = Math.max(dx, dy);

  const PAD = 0.95;
  const TINY_THRESHOLD = 30;
  const TARGET_PX = 70;
  const MAX_FIT_ZOOM = 3.2;

  let kFit = PAD / Math.max(dx / w, dy / h);
  kFit = Math.min(kFit, MAX_FIT_ZOOM);

  let k = kFit;
  if (largest < TINY_THRESHOLD){
    k = Math.max(kFit, TARGET_PX / largest);
  }

  k = Math.min(18, Math.max(0.35, k));

  const cx = (x0 + x1) / 2;
  const cy = (y0 + y1) / 2;

  svg.call(zoom.transform, d3.zoomIdentity.translate((w/2)-k*cx, (h/2)-k*cy).scale(k));
}

/* Game */
function pickAnswer(){
  const pool = activePool.length ? activePool : allFeatures;
  answerFeature = pool[Math.floor(Math.random()*pool.length)];
}
function newRound(){
  resetRoundUI();
  setActivePool();
  pickAnswer();
  requestAnimationFrame(() => renderSilhouette(answerFeature));
}

/* Guessing/hints */
function haversineKm(lat1, lon1, lat2, lon2){
  const R = 6371.0088;
  const toRad = d => d * Math.PI/180;
  const φ1 = toRad(lat1), φ2 = toRad(lat2);
  const dφ = toRad(lat2-lat1);
  const dλ = toRad(lon2-lon1);
  const a = Math.sin(dφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function bearingDeg(lat1, lon1, lat2, lon2){
  const toRad = d => d * Math.PI/180;
  const toDeg = r => r * 180/Math.PI;
  const φ1 = toRad(lat1), φ2 = toRad(lat2);
  const λ1 = toRad(lon1), λ2 = toRad(lon2);
  const y = Math.sin(λ2-λ1) * Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);
  return (toDeg(Math.atan2(y,x)) + 360) % 360;
}
function bearingToCompassAndArrow(b){
  if (b >= 337.5 || b < 22.5)  return {label:"N",  arrow:"↑"};
  if (b < 67.5)   return {label:"NE", arrow:"↗"};
  if (b < 112.5)  return {label:"E",  arrow:"→"};
  if (b < 157.5)  return {label:"SE", arrow:"↘"};
  if (b < 202.5)  return {label:"S",  arrow:"↓"};
  if (b < 247.5)  return {label:"SW", arrow:"↙"};
  if (b < 292.5)  return {label:"W",  arrow:"←"};
  return {label:"NW", arrow:"↖"};
}
function formatKm(km){ return Math.round(km).toLocaleString() + " km"; }
function wrongGuessHint(guessed, answer){
  const [lon1, lat1] = d3.geoCentroid(guessed);
  const [lon2, lat2] = d3.geoCentroid(answer);
  const km = haversineKm(lat1, lon1, lat2, lon2);
  const b = bearingDeg(lat1, lon1, lat2, lon2);
  const {label, arrow} = bearingToCompassAndArrow(b);
  return `${arrow} ${label} • ${formatKm(km)}`;
}
function submitGuess(){
  if (!answerFeature) return;
  const raw = els.guess.value.trim();
  const key = norm(raw);
  if (!key) return;

  const guessed = byName.get(key);
  if (!guessed){
    addGuessLine(raw, "Not found", "err");
    setHint("Not found — open the list and pick, or type more.");
    // reset picker search after a failed submit too
    resetCountryPicker();
    return;
  }

  attempts += 1;
  els.attempts.textContent = String(attempts);

  const gName = getName(guessed);
  const aName = getName(answerFeature);

  if (norm(gName) === norm(aName)){
    addGuessLine(gName, "Correct", "good");
    setHint("✅ Correct!");
    setAnswer(aName);
  } else {
    const hintText = wrongGuessHint(guessed, answerFeature);
    addGuessLine(gName, hintText, "bad");
    setHint(`Wrong — answer is ${hintText} from your guess.`);
  }

  // After every guess, clear search + guess input so next attempt starts clean
  resetCountryPicker();
}
function giveUp(){
  if (!answerFeature) return;
  const aName = getName(answerFeature);
  setAnswer(aName);
  setHint("Answer revealed. Tap New for another.");
  resetCountryPicker();
}

/* Data */
async function loadData(){
  const url = "https://unpkg.com/world-atlas@2.0.2/countries-10m.json";
  const world = await fetch(url).then(r => {
    if (!r.ok) throw new Error(`Fetch failed: ${r.status} ${r.statusText}`);
    return r.json();
  });

  const obj = world.objects.countries || Object.values(world.objects)[0];
  allFeatures = topojson.feature(world, obj).features;

  byName.clear();
  allNames = allFeatures.map(getName).filter(Boolean).sort((a,b)=>a.localeCompare(b));
  for (const f of allFeatures){
    const n = getName(f);
    if (n) byName.set(norm(n), f);
  }

  renderCountryList("");
}

/* Events */
function wireEvents(){
  // Mode modal open
  els.modeBtn.addEventListener("click", () => {
    openModal(els.modeBackdrop, els.modeModal);
    renderModeList();
    setTimeout(sizeModeList, 0);
  });
  els.modeBackdrop.addEventListener("pointerdown", () => { closeModal(els.modeBackdrop, els.modeModal); clearModeSelection(); });
  els.modeClose.addEventListener("click", () => { closeModal(els.modeBackdrop, els.modeModal); clearModeSelection(); });
  els.modeConfirmBtn.addEventListener("click", confirmMode);

  // Country modal open (tap in guess box OR focus)
  const openCountry = () => {
    openModal(els.countryBackdrop, els.countryModal);
    // keep current typed text in search when opening, but selection behavior stays identical to mode
    els.countrySearch.value = els.guess.value.trim();
    renderCountryList(els.countrySearch.value);
    setTimeout(() => {
      sizeCountryList();
      els.countrySearch.focus({preventScroll:true});
    }, 0);
  };
  els.guess.addEventListener("pointerdown", openCountry);
  els.guess.addEventListener("focus", openCountry);

  // Country search filters list
  els.countrySearch.addEventListener("input", () => {
    // mirror typing into main guess input (one input box only on page; search is inside modal)
    els.guess.value = els.countrySearch.value;
    renderCountryList(els.countrySearch.value);
  });

  // Confirm
  els.countryConfirmBtn.addEventListener("click", confirmCountry);

  // Close country
  els.countryBackdrop.addEventListener("pointerdown", () => { closeModal(els.countryBackdrop, els.countryModal); clearCountrySelection(); });
  els.countryClose.addEventListener("click", () => { closeModal(els.countryBackdrop, els.countryModal); clearCountrySelection(); });

  // Enter submits from main input or search input
  els.guess.addEventListener("keydown", (e) => {
    if (e.key === "Enter") submitGuess();
  });
  els.countrySearch.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      // If a country is selected, confirm it; otherwise submit typed guess
      if (selectedCountryName) confirmCountry();
      else { closeModal(els.countryBackdrop, els.countryModal); submitGuess(); }
    } else if (e.key === "Escape"){
      closeModal(els.countryBackdrop, els.countryModal);
      clearCountrySelection();
    }
  });

  // Buttons
  els.guessBtn.addEventListener("click", () => {
    closeModal(els.countryBackdrop, els.countryModal);
    clearCountrySelection();
    submitGuess();
  });
  els.newBtn.addEventListener("click", () => {
    closeModal(els.countryBackdrop, els.countryModal);
    closeModal(els.modeBackdrop, els.modeModal);
    clearCountrySelection();
    clearModeSelection();
    resetCountryPicker();
    newRound();
  });
  els.giveUpBtn.addEventListener("click", () => {
    closeModal(els.countryBackdrop, els.countryModal);
    closeModal(els.modeBackdrop, els.modeModal);
    clearCountrySelection();
    clearModeSelection();
    giveUp();
  });

  // Resize
  window.addEventListener("resize", () => {
    sizeCountryList();
    sizeModeList();
    if (!answerFeature) return;
    d3.select("#silWrap").selectAll("*").remove();
    initSvg();
    requestAnimationFrame(() => renderSilhouette(answerFeature));
  });
}

/* Start */
(async function start(){
  initSvg();
  await loadData();
  wireEvents();
  currentMode = "All Countries";
  els.modeBtn.textContent = currentMode;
  newRound();
})();
</script>

</body>
</html>
